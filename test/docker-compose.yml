services:
  # Cypress test runner service
  cypress-tests:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cypress-template-tests
    ipc: host
    environment:
      - CI=true
      - CYPRESS_baseUrl=${CYPRESS_baseUrl:-http://localhost:5173}
      - CYPRESS_apiUrl=${CYPRESS_apiUrl:-http://localhost:3000/api}
      - QASE_API_TOKEN=${QASE_API_TOKEN}
      - QASE_PROJECT_CODE=${QASE_PROJECT_CODE}
    volumes:
      # Mount source code for live updates during development
      - ./cypress:/app/cypress
      - ./cypress.config.ts:/app/cypress.config.ts
      - ./tsconfig.json:/app/tsconfig.json

      # Mount test artifacts to access from host
      - ./cypress/videos:/app/cypress/videos
      - ./cypress/screenshots:/app/cypress/screenshots
      - ./cypress/reports:/app/cypress/reports

      # Cache node_modules to improve performance
      - node_modules:/app/node_modules
    working_dir: /app
    command: npm test
    networks:
      - cypress-network

  # Example: Application under test (optional)
  # Uncomment and configure if you want to test a local application
  # app:
  #   image: node:18-alpine
  #   container_name: app-under-test
  #   working_dir: /app
  #   volumes:
  #     - ./app:/app
  #   ports:
  #     - "3000:3000"
  #   command: npm start
  #   networks:
  #     - cypress-network
  #   healthcheck:
  #     test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

volumes:
  node_modules:

networks:
  cypress-network:
    driver: bridge
